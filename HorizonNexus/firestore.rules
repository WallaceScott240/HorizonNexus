rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Rules for user profiles
    match /users/{userId} {
      // Admins can read/write any user. Users can read/write their own profile.
      allow read, list, write: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'admin');
    }

    // Rules for assignments and their sub-collections
    match /assignments/{assignmentId} {
      // Any authenticated user can read an assignment's details.
      allow read: if request.auth != null;
      
      // Only admins and teachers can create, update, or delete an assignment.
      allow write: if request.auth.token.role in ['admin', 'teacher'];

      // Rules for the 'submissions' sub-collection within each assignment
      match /submissions/{studentId} {
        // A student can read their own submission. Admins/teachers can read any submission.
        allow read: if request.auth != null && (request.auth.uid == studentId || request.auth.token.role in ['admin', 'teacher']);
        
        // A student can only write (create, update, delete) their own submission.
        allow write: if request.auth != null && request.auth.uid == studentId;
      }
    }
    
    // Rules for announcements
    match /announcements/{announcementId} {
      // Any authenticated user can read announcements.
      allow read: if request.auth != null;
      
      // Only admins and teachers can write announcements.
      allow write: if request.auth.token.role in ['admin', 'teacher'];
    }
  }
}